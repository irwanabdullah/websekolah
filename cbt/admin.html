<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>CBT Admin Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card-dash { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 10px; background: white; }
        .hidden { display: none !important; }
        .table-responsive { max-height: 500px; overflow-y: auto; }
    </style>
</head>
<body>

    <nav id="navbarAdmin" class="navbar navbar-dark bg-dark mb-4 sticky-top" style="display:none;">
        <div class="container">
            <span class="navbar-brand mb-0 h1"><i class="fas fa-user-shield"></i> CBT Admin</span>
            <div>
                <button id="btn-nav-admin" onclick="switchView('view-admin')" class="btn btn-outline-light btn-sm me-2">Soal & Mapel</button>
                <button id="btn-nav-nilai" onclick="loadHasilNilai()" class="btn btn-outline-light btn-sm me-2">Data Nilai</button>
                <button onclick="logout()" class="btn btn-danger btn-sm">Keluar</button>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <div id="view-login" class="row justify-content-center" style="margin-top: 100px;">
            <div class="col-md-4">
                <div class="card card-dash p-4">
                    <div class="text-center mb-3">
                        <i class="fas fa-lock fa-3x text-secondary"></i>
                        <h4 class="mt-2">Login Admin / Guru</h4>
                    </div>
                    <form id="formLogin">
                        <div class="mb-3">
                            <label>Username</label>
                            <input type="text" id="username" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label>Password</label>
                            <input type="password" id="password" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Masuk</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="view-admin" class="hidden">
            <div id="section-mapel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4><i class="fas fa-book"></i> Daftar Mata Pelajaran</h4>
                    <button onclick="refreshMapelTable()" class="btn btn-sm btn-outline-primary">Refresh</button>
                </div>

                <div class="card card-dash p-3 mb-5">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr><th>Mata Pelajaran</th><th>Status</th><th>Aksi</th></tr>
                            </thead>
                            <tbody id="tableMapel"><tr><td colspan="3" class="text-center">Memuat...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <h4 class="mb-3"><i class="fas fa-plus-circle"></i> Input Soal Baru</h4>
            <div class="card card-dash p-4 mb-5">
                <div id="formSoalContainer"></div> 
            </div>
        </div>

        <div id="view-nilai" class="hidden">
            <h4 class="mb-3"><i class="fas fa-poll"></i> Rekap Hasil Ujian</h4>
            
            <div class="card card-dash p-3 mb-3 bg-light">
                <div class="row g-2 align-items-end">
                    <div class="col-md-3">
                        <label class="small fw-bold">Filter Mapel:</label>
                        <select id="filterMapel" class="form-select" onchange="applyFilter()">
                            <option value="ALL">Semua Mapel</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="small fw-bold">Filter Kelas:</label>
                        <select id="filterKelas" class="form-select" onchange="applyFilter()">
                            <option value="ALL">Semua Kelas</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button onclick="loadHasilNilai()" class="btn btn-primary w-100"><i class="fas fa-sync"></i> Refresh</button>
                    </div>
                    <div class="col-md-3">
                        <button onclick="exportToExcel()" class="btn btn-success w-100"><i class="fas fa-file-excel"></i> Export Excel</button>
                    </div>
                </div>
            </div>

            <div class="card card-dash p-3">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover small" id="tabelNilaiFull">
                        <thead class="table-dark">
                            <tr>
                                <th>Waktu</th>
                                <th>Nama Siswa</th>
                                <th>Kelas</th>
                                <th>Mapel</th>
                                <th>Skor</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyNilai">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <template id="templateFormSoal">
        <form onsubmit="simpanSoal(event)">
            <div class="mb-3">
                <label class="fw-bold">Pilih Mapel:</label>
                <select id="pelajaran_id" class="form-select" required><option value="" disabled selected>Pilih Mapel...</option></select>
            </div>
            <label class="fw-bold">Pertanyaan:</label>
            <div class="input-group mb-1">
                <textarea id="q" class="form-control" placeholder="Tulis pertanyaan..." rows="2" required></textarea>
                <button type="button" class="btn btn-outline-secondary" onclick="triggerUpload('q')"><i class="fas fa-image"></i></button>
            </div>
            <div id="preview_q" class="mb-3"></div>

            <div class="row g-2">
                <div class="col-md-6">
                    <div class="input-group mb-1"><span class="input-group-text">A</span><input id="a" class="form-control" required><button type="button" class="btn btn-outline-secondary" onclick="triggerUpload('a')"><i class="fas fa-image"></i></button></div><div id="preview_a" class="mb-2"></div>
                </div>
                <div class="col-md-6">
                    <div class="input-group mb-1"><span class="input-group-text">B</span><input id="b" class="form-control" required><button type="button" class="btn btn-outline-secondary" onclick="triggerUpload('b')"><i class="fas fa-image"></i></button></div><div id="preview_b" class="mb-2"></div>
                </div>
                <div class="col-md-6">
                    <div class="input-group mb-1"><span class="input-group-text">C</span><input id="c" class="form-control" required><button type="button" class="btn btn-outline-secondary" onclick="triggerUpload('c')"><i class="fas fa-image"></i></button></div><div id="preview_c" class="mb-2"></div>
                </div>
                <div class="col-md-6">
                    <div class="input-group mb-1"><span class="input-group-text">D</span><input id="d" class="form-control" required><button type="button" class="btn btn-outline-secondary" onclick="triggerUpload('d')"><i class="fas fa-image"></i></button></div><div id="preview_d" class="mb-2"></div>
                </div>
            </div>

            <div class="input-group mt-3">
                <label class="input-group-text bg-warning">Kunci</label>
                <select id="kunci" class="form-select fw-bold" required><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select>
                <button type="submit" class="btn btn-success px-4 fw-bold">SIMPAN</button>
            </div>
        </form>
        <input type="file" id="hiddenFileInput" style="display:none" accept="image/*" onchange="handleFileSelect(this)">
    </template>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        // --- GANTI URL WEB APP ANDA DI SINI ---
        const API_URL = 'https://script.google.com/macros/s/AKfycby0B4IP3pRVGDAWnCmXwe7Yzu5zjVK0P48D_2Fd7maDBlzCghbRpLY_UGczi2j6GMGE/exec'; 
        
        let currentUser = null;
        let mapelList = [];
        let allNilaiData = []; 
        let activeUploadFieldId = null; 

        // --- AUTH & NAV ---
        document.getElementById('formLogin').addEventListener('submit', async (e) => {
            e.preventDefault();
            Swal.showLoading();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            
            try {
                const res = await fetchAPI({ action: 'login', payload: {username: u, password: p} });
                Swal.close();
                if (res.status === 'success' && (res.data.role === 'admin' || res.data.role === 'guru')) {
                    currentUser = res.data;
                    document.getElementById('navbarAdmin').style.display = 'block';
                    document.getElementById('view-login').classList.add('hidden');
                    renderFormTemplate();
                    
                    // --- MODIFIKASI TAMPILAN BERDASARKAN ROLE ---
                    if(currentUser.role === 'guru') {
                        // Jika guru: Sembunyikan tombol nilai dan area daftar mapel
                        document.getElementById('btn-nav-nilai').classList.add('hidden');
                        document.getElementById('section-mapel').classList.add('hidden');
                        document.getElementById('btn-nav-admin').innerText = 'Input Soal'; // Ganti teks nav
                    } else {
                        // Jika admin: Tampilkan semua
                        document.getElementById('btn-nav-nilai').classList.remove('hidden');
                        document.getElementById('section-mapel').classList.remove('hidden');
                        document.getElementById('btn-nav-admin').innerText = 'Soal & Mapel';
                    }
                    
                    switchView('view-admin');
                } else {
                    Swal.fire('Gagal', 'Akses ditolak atau password salah.', 'error');
                }
            } catch(e) { Swal.fire('Error', 'Koneksi gagal.', 'error'); }
        });

        function switchView(viewId) {
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-admin').classList.add('hidden');
            document.getElementById('view-nilai').classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');
            if(viewId === 'view-admin') refreshMapelTable();
        }
        function logout() { location.reload(); }

        // --- SOAL & MAPEL ---
        function renderFormTemplate() {
            const tpl = document.getElementById('templateFormSoal').content.cloneNode(true);
            document.getElementById('formSoalContainer').innerHTML = '';
            document.getElementById('formSoalContainer').appendChild(tpl);
        }

        async function refreshMapelTable() {
            const res = await fetchAPI({ action: 'getAdminData' });
            if (res.status === 'success') {
                mapelList = res.data;
                const tbody = document.getElementById('tableMapel');
                const select = document.getElementById('pelajaran_id');
                tbody.innerHTML = '';
                if(select) select.innerHTML = '<option value="" disabled selected>Pilih Mapel...</option>';

                mapelList.forEach(m => {
                    if(select) select.innerHTML += `<option value="${m.id}">${m.nama}</option>`;
                    const btnClass = m.status === 'Aktif' ? 'btn-success' : 'btn-secondary';
                    tbody.innerHTML += `
                        <tr>
                            <td><b>${m.nama}</b><br><small>${m.deskripsi}</small></td>
                            <td><span class="badge ${m.status === 'Aktif' ? 'bg-success' : 'bg-danger'}">${m.status}</span></td>
                            <td><button onclick="toggleStatus('${m.id}', '${m.status}')" class="btn btn-sm ${btnClass}">${m.status === 'Aktif' ? 'Nonaktifkan' : 'Aktifkan'}</button></td>
                        </tr>`;
                });
            }
        }
        
        async function toggleStatus(id, current) {
            await fetchAPI({ action: 'updateStatusMapel', payload: { id, status: current==='Aktif'?'Nonaktif':'Aktif' } });
            refreshMapelTable();
        }

        async function simpanSoal(e) {
            e.preventDefault();
            Swal.showLoading();
            const payload = {
                pelajaran_id: document.getElementById('pelajaran_id').value,
                pertanyaan: document.getElementById('q').value,
                opsi_a: document.getElementById('a').value,
                opsi_b: document.getElementById('b').value,
                opsi_c: document.getElementById('c').value,
                opsi_d: document.getElementById('d').value,
                kunci: document.getElementById('kunci').value
            };
            const res = await fetchAPI({ action: 'tambahSoal', payload });
            Swal.close();
            if(res.status === 'success') {
                Swal.fire('Sukses', 'Soal tersimpan', 'success');
                // Reset form inputs (tanpa reset mapel)
                ['q','a','b','c','d'].forEach(id => { 
                    document.getElementById(id).value = ''; 
                    document.getElementById('preview_'+id).innerHTML = '';
                });
            } else Swal.fire('Gagal', res.message, 'error');
        }

        // --- NILAI & EXPORT ---
        async function loadHasilNilai() {
            switchView('view-nilai');
            document.getElementById('tbodyNilai').innerHTML = '<tr><td colspan="5" class="text-center">Memuat data...</td></tr>';
            const res = await fetchAPI({ action: 'getHasilUjian' });
            
            if (res.status === 'success') {
                allNilaiData = res.data;
                populateFilters();
                applyFilter();
            } else {
                document.getElementById('tbodyNilai').innerHTML = '<tr><td colspan="5" class="text-danger">Gagal memuat data.</td></tr>';
            }
        }

        function populateFilters() {
            const selMapel = document.getElementById('filterMapel');
            const selKelas = document.getElementById('filterKelas');
            selMapel.innerHTML = '<option value="ALL">Semua Mapel</option>';
            selKelas.innerHTML = '<option value="ALL">Semua Kelas</option>';

            if (!allNilaiData || allNilaiData.length === 0) return;

            const mapelSet = new Set();
            const kelasSet = new Set();

            allNilaiData.forEach(item => {
                if(item.mapel) mapelSet.add(item.mapel);
                // Pastikan kelas tidak null/undefined
                let kls = item.kelas ? String(item.kelas).trim() : "-";
                if(kls === "") kls = "-";
                kelasSet.add(kls);
            });

            mapelSet.forEach(m => selMapel.innerHTML += `<option value="${m}">${m}</option>`);
            // Sort kelas agar rapi
            Array.from(kelasSet).sort().forEach(k => selKelas.innerHTML += `<option value="${k}">${k}</option>`);
        }

        function applyFilter() {
            const fMapel = document.getElementById('filterMapel').value;
            const fKelas = document.getElementById('filterKelas').value;
            const tbody = document.getElementById('tbodyNilai');
            tbody.innerHTML = '';

            const filtered = allNilaiData.filter(item => {
                // Logic Filter Aman
                let itemKelas = item.kelas ? String(item.kelas).trim() : "-";
                if(itemKelas === "") itemKelas = "-";
                
                const matchMapel = (fMapel === 'ALL') || (item.mapel === fMapel);
                const matchKelas = (fKelas === 'ALL') || (itemKelas === fKelas);
                return matchMapel && matchKelas;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Data tidak ditemukan.</td></tr>';
                return;
            }

            filtered.forEach(item => {
                let waktu = item.waktu;
                try { waktu = new Date(item.waktu).toLocaleString('id-ID'); } catch(e){}
                tbody.innerHTML += `<tr>
                    <td>${waktu}</td>
                    <td class="fw-bold">${item.nama}</td>
                    <td>${item.kelas || '-'}</td>
                    <td>${item.mapel}</td>
                    <td>${item.skor}</td>
                </tr>`;
            });
        }

        function exportToExcel() {
            if (typeof XLSX === 'undefined') {
                Swal.fire('Error', 'Library Excel belum siap.', 'error');
                return;
            }
            const table = document.getElementById("tabelNilaiFull"); // Ambil full table
            if (!table || table.rows.length <= 1) {
                Swal.fire('Info', 'Data kosong.', 'warning');
                return;
            }
            
            const wb = XLSX.utils.table_to_book(table, {sheet: "Nilai"});
            const fname = `Rekap_Nilai_${new Date().getTime()}.xlsx`;
            XLSX.writeFile(wb, fname);
        }

        // --- UPLOAD IMAGE ---
        function triggerUpload(id) { activeUploadFieldId = id; document.getElementById('hiddenFileInput').click(); }
        
        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                if (file.size > 2*1024*1024) return Swal.fire('Error','File > 2MB','warning');
                
                const reader = new FileReader();
                Swal.fire({title:'Mengupload...', didOpen:()=>Swal.showLoading()});
                reader.onload = async function(e) {
                    const payload = { data: e.target.result.split(',')[1], mimeType: file.type, name: file.name };
                    const res = await fetchAPI({ action: 'uploadFile', payload });
                    Swal.close();
                    if(res.status==='success') {
                        document.getElementById(activeUploadFieldId).value += `<br><img src="${res.url}" style="max-width:100%"><br>`;
                        document.getElementById('preview_'+activeUploadFieldId).innerHTML = `<img src="${res.url}" height="50"> <i class="fas fa-check text-success"></i>`;
                    } else Swal.fire('Gagal', res.message, 'error');
                };
                reader.readAsDataURL(file);
            }
            input.value = '';
        }

        async function fetchAPI(body) {
            const response = await fetch(API_URL, { method: 'POST', body: JSON.stringify(body) });
            return await response.json();
        }
    </script>
</body>
</html>
